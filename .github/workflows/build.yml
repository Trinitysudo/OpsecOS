name: Build OpsecOS ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build ISO in Arch Container
        run: |
          docker run --privileged --rm -v $(pwd):/workspace -w /workspace archlinux:latest bash -c "
            # Initialize keyring
            pacman-key --init &&
            pacman-key --populate archlinux &&
            
            # Use the local pacman.conf for the container to enable EndeavourOS
            cp /workspace/pacman.conf /etc/pacman.conf
            
            # Create symlink for live setup service
            mkdir -p /workspace/airootfs/etc/systemd/system/multi-user.target.wants/
            ln -sf /etc/systemd/system/ghost-live-setup.service /workspace/airootfs/etc/systemd/system/multi-user.target.wants/ghost-live-setup.service
            
            # Install build tools
            pacman -Syu --noconfirm archiso grub syslinux mtools libisoburn &&
            
            # Run build
            bash build_iso.sh
          "

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpsecOS-ISO
          path: out/*.iso
