#!/usr/bin/env bash

# Deploy Custom Calamares Configs
# We move these at boot to avoid pacman conflicts during build
[[ -f /etc/calamares/modules/displaymanager.conf.opsec ]] && mv /etc/calamares/modules/displaymanager.conf.opsec /etc/calamares/modules/displaymanager.conf
[[ -f /etc/calamares/modules/partition.conf.opsec ]] && mv /etc/calamares/modules/partition.conf.opsec /etc/calamares/modules/partition.conf
[[ -f /etc/calamares/modules/unpackfs.conf.opsec ]] && mv /etc/calamares/modules/unpackfs.conf.opsec /etc/calamares/modules/unpackfs.conf
[[ -f /etc/calamares/modules/users.conf.opsec ]] && mv /etc/calamares/modules/users.conf.opsec /etc/calamares/modules/users.conf
[[ -f /etc/calamares/modules/netinstall.conf.opsec ]] && mv /etc/calamares/modules/netinstall.conf.opsec /etc/calamares/modules/netinstall.conf
[[ -f /etc/calamares/modules/netinstall_software.yaml.opsec ]] && mv /etc/calamares/modules/netinstall_software.yaml.opsec /etc/calamares/modules/netinstall_software.yaml

# Clean up empty shadow file if it exists to allow gpasswd/user generation
[[ -s /etc/shadow ]] || rm -f /etc/shadow

# Set Defaults for the Live User (arch)
# We use gsettings to set wallpaper and icons for Gnome/Cinnamon
if [[ -n "$DISPLAY" ]] || [[ "$XDG_SESSION_TYPE" == "wayland" ]]; then
    # Set Wallpaper (Assuming background_blue.png exists as per user request)
    gsettings set org.gnome.desktop.background picture-uri "file:///usr/share/backgrounds/ghostos/background_blue.png"
    gsettings set org.gnome.desktop.background picture-uri-dark "file:///usr/share/backgrounds/ghostos/background_blue.png"
    
    # Set Icons & Cursor
    gsettings set org.gnome.desktop.interface icon-theme 'Papirus-Dark'
    gsettings set org.gnome.desktop.interface cursor-theme 'Adwaita'
    gsettings set org.gnome.desktop.interface font-name 'Inter 11'
fi

# Enable NetworkManager
systemctl enable NetworkManager

# Enable GDM
systemctl enable gdm

# Enable AppArmor
systemctl enable apparmor

# Enable dnscrypt-proxy
systemctl enable dnscrypt-proxy

# Set up autologin for the live user (archiso default is 'arch')
mkdir -p /etc/gdm
cat > /etc/gdm/custom.conf <<EOF
[daemon]
AutomaticLoginEnable=True
AutomaticLogin=arch
EOF
