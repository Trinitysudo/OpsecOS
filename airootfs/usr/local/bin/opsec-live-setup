#!/usr/bin/env bash

# Deploy Custom Calamares Configs
# We move these at boot to avoid pacman conflicts during build
[[ -f /etc/calamares/modules/displaymanager.conf.opsec ]] && mv /etc/calamares/modules/displaymanager.conf.opsec /etc/calamares/modules/displaymanager.conf
[[ -f /etc/calamares/modules/partition.conf.opsec ]] && mv /etc/calamares/modules/partition.conf.opsec /etc/calamares/modules/partition.conf
[[ -f /etc/calamares/modules/unpackfs.conf.opsec ]] && mv /etc/calamares/modules/unpackfs.conf.opsec /etc/calamares/modules/unpackfs.conf
[[ -f /etc/calamares/modules/users.conf.opsec ]] && mv /etc/calamares/modules/users.conf.opsec /etc/calamares/modules/users.conf

# Clean up empty shadow file if it exists to allow gpasswd/user generation
[[ -s /etc/shadow ]] || rm -f /etc/shadow

# Enable NetworkManager
systemctl enable NetworkManager

# Enable GDM
systemctl enable gdm

# Enable AppArmor
systemctl enable apparmor

# Enable dnscrypt-proxy
systemctl enable dnscrypt-proxy

# Set up autologin for the live user (archiso default is 'arch')
mkdir -p /etc/gdm
cat > /etc/gdm/custom.conf <<EOF
[daemon]
AutomaticLoginEnable=True
AutomaticLogin=arch
EOF
